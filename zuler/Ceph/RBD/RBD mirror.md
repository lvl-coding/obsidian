# 网络配置
RBD image跨集群同步需要目标端集群能够访问源端集群，访问的途径为ceph.conf，通过特定集群名对应的conf文件，比如cephA.conf或cephB.conf，重命名拷贝过来的ceph.conf即可
```ini
# minimal ceph.conf for 2a4e1392-0abd-11f0-95f6-e7d0a414706b
[global]
        fsid = 2a4e1392-0abd-11f0-95f6-e7d0a414706b
        mon_host = [v2:192.168.10.90:3300/0,v1:192.168.10.90:6789/0] [v2:192.168.10.91:3300/0,v1:192.168.10.91:6789/0] [v2:192.168.10.92:3300/0,v1:192.168.10.92:6789/0]
```
通信的依赖为集群的fsid，和mon的ip及端口号，目标端集群在通过ceph.conf配置能够访问源集群的mon的mon节点。
当源端集群和目标端集群分别在不同的内网时，则需要通过公网ip映射的方式使目标集群通过ceph.conf内的mon ip信息访问源集群，可通过ipvs做ip映射转发实现，在目标端将源端的mon ip映射为其所在公网ip，在源端将其公网ip转发为目标端ip。所需转发端口有三类
 1. mon的v2版本ip端口，即3300
 2. mon的v1版本ip端口，即6789，当前版本已不适用，可忽略
 3. RBD mirror数据传输的端口，为一个区间分配，从6800到7300
目标段ipvs配置说明
- 设置ipvs服务的流量转发持久化，此参数为特定客户端的流量在制定时间内转发给同一服务端
- 需要转发的端口有3300、6789和6800-7300，因此在允许的情况直接做全端口转发，比如将流向192.168.12.2 ip的流量转发至58.220.67.199 ip中
- 目标集群中的RBD mirror服务需要访问源端集群的所有节点，因此需在目标集群的每个节点都设置所有源端集群的ip到源端所在公网ip的转发
```bash
$ ipvsadm -A -t 192.168.12.2:0 -p 86400 -s rr
$ ipvsadm -a -t 192.168.12.2:0 -r 58.220.67.199:0 -m
$ ipvsadm -A -t 192.168.12.3:0 -p 86400 -s rr
$ ipvsadm -a -t 192.168.12.3:0 -r 58.220.67.200:0 -m
$ ipvsadm -A -t 192.168.12.4:0 -p 86400 -s rr
$ ipvsadm -a -t 192.168.12.4:0 -r 58.220.67.201:0 -m
$ ipvsadm -L -n
```
- RBD迁移完成后需将添加的ipvs服务配置删除
```bash
$ ipvsadm -L -n
$ ipvsadm -D -t 192.168.12.2:0
$ ipvsadm -D -t 192.168.12.3:0
$ ipvsadm -D -t 192.168.12.4:0
$ ipvsadm -L -n
```
源端目标配置说明
- 设置ipvs服务的流量转发持久化，此参数为特定客户端的流量在制定时间内转发给同一服务端
- 需要转发的端口有3300、6789和6800-7300，因此在允许的情况直接做全端口转发，比如将流向58.220.67.200 ip的流量转发至192.168.12.3:0 ip中
- 目标集群中的RBD mirror服务需要访问源端集群的所有节点，因此需在源集群的每个节点都设置自身公网的ip到自身mon ip的转发
- RBD迁移完成后需将添加的ipvs服务配置删除
```bash
$ ipvsadm -A -t 58.220.67.200:0 -p 86400 -s rr
$ ipvsadm -A -t 58.220.67.200:0 -r 192.168.12.3:0 -m
$ ipvsadm -a -t 58.220.67.200:0 -r 192.168.12.3:0 -m
$ ipvsadm -L -n
$ ipvsadm -D -t 58.220.67.200:0
$ ipvsadm -L -n
```
## 防火墙配置
源端和目标端均需开启上述三类端口的防火墙规则，源端需针对目标端所在公网ip开启对应端口，目标端需针对源端所在公网ip开启对应端口
```bash
$ ufw allow from 222.65.226.99 to any port 6800:7300 proto tcp
$ ufw allow from 222.65.226.99 to any port 3300
```
## 配置完成确认
```bash
$ telnet 192.168.10.90 3300
Trying 192.168.10.90...
Connected to 192.168.10.90.
Escape character is '^]'.
ceph v2

```